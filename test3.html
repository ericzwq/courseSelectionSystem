<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <style>
    .test {
      display: none;
    }

    table {
      /*border-collapse: collapse;*/
      /*text-align: center;*/
    }

    td {
      /*height: 60px;*/
    }
  </style>
</head>
<body>
<table class="test" style="text-align:center;border-collapse: collapse;border:black;height: 360px;" border="1">
  <tr style="background: #cccc">
    <td>杀了对方角度来说放假对方角度来说放假对方角度来说放假对方角度来说放假对方角度来说放假对方角度来说放假对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
  </tr>
  <tr>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
  </tr>
  <tr style="background: #cccc">
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
  </tr>
  <tr>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
  </tr>
  <tr style="background: #cccc">
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
  </tr>
  <tr>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
    <td>杀了对方角度来说放假放假</td>
  </tr>
</table>
<a download="pic" class="down">下载</a>
<script>
  let node = document.querySelector('.test')
  let newNode = node.cloneNode(true)
  let w = 4000
  let h = 360
  newNode.setAttribute("xmlns", "http://www.w3.org/1999/xhtml")
  newNode.style.width = w + 'px'
  newNode.style.height = h + 'px'
  let nodeStr = new XMLSerializer().serializeToString(newNode)
  let src = `data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">
    <foreignObject x="0" y="0" width="100%" height="100%">
      ${nodeStr}
    </foreignObject>
  </svg>`.replace(/\n/g,'').replace(/#/g, '%23')
  getBase64PNG(src, {w, h}).then(blob => {
    document.querySelector('.down').href = URL.createObjectURL(blob)
  }).catch(r => console.log(r))

  function getBase64PNG(svgStr, {w, h}) {
    let image = new Image();
    image.src = svgStr;
    return new Promise((resolve, reject) => {
      image.onload = function () {
        let canvas = document.createElement("canvas");
        canvas.width = w * 2;
        canvas.height = h * 2;
        let ctx = canvas.getContext("2d");
        ctx.scale(2, 2)
        ctx.drawImage(image, 0, 0);
        // resolve(canvas.toDataURL("image/png"));
        resolve(new Promise((resolve2, reject2) => {
          canvas.toBlob(blob => {
            resolve2(blob)
          }, 'image/png', 1)
        }))
      }
      image.onerror = function () {
        reject('图片加载失败')
      }
    })
  }

  /**
   *将donm转换成图片并下载到本地
   *
   * @param {HTMLElement} target
   * @param {string} name
   */
  function downloadDomToImg(target, name) {
    const src = getImgByDom({target});
    let pngSrc = getBase64PNG(src, document.querySelector('.test'))
    console.log(src)
    console.log(pngSrc)
    const aEle = window.document.createElement("a");
    aEle.style.display = "none";
    aEle.download = name;
    const img = new Image();
    // img.src = src;
    img.src = pngSrc;
    img.onload = () => {
      // aEle.href = src;
      aEle.href = pngSrc;
      window.document.body.appendChild(aEle);
      aEle.click();
      window.document.body.removeChild(aEle);
    };
  }

  /**
   *获取dom对应图片的base64地址
   *
   * @param {Object} params
   * @returns 图片的base64地址
   */
  function getImgByDom(params) {
    const {
      target,
      filterSelector,
      imgSelector,
      canvasSelector,
      styleStr,
      specialHandle,
    } = params;
    //克隆一份dom节点
    const cloneDom = target.cloneNode(true);
    cloneDom.setAttribute("xmlns", "http://www.w3.org/1999/xhtml");
    cloneDom.classList.remove('test')
    cloneDom.children[0].classList.remove('sub')
    const width = target.offsetWidth;
    const height = target.offsetHeight;
    console.log(cloneDom)
// console.log(new XMLSerializer().serializeToString(cloneDom))
    //处理要隐藏的元素
    // handleFilterDom(filterSelector, cloneDom);

    //处理图片
    // handleImgDom(imgSelector, target, cloneDom);

    //处理canvas
    // handleCanvasDom(canvasSelector, target, cloneDom);

    //其他处理
    // handleCloneDom(specialHandle, cloneDom);

    //转成base64位地址
    const xmlContent = `data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg"
  width="${width}" height="${height}"><foreignObject x="0" y="0" width="100%" height="100%">
  ${new XMLSerializer().serializeToString(cloneDom)}${styleStr || ''}
    </foreignObject></svg>`;

    //处理部分特殊字符
    return xmlContent.replace(/\n/g, "").replace(/\t/g, "").replace(/#/g, "%23");
  }

  /**
   * 处理img元素
   * @param {string} imgSelector img元素的选择器
   * @param {HTMLElement} target 源dom
   * @param {HTMLElement} cloneDom clone出来的dom
   */
  function handleImgDom(imgSelector, target, cloneDom) {
    if (!imgSelector) return;
    const imgList = cloneDom.querySelectorAll(imgSelector);
    const realImgList = target.querySelectorAll(imgSelector);
    for (let i = 0, l = imgList.length; i < l; i++) {
      imgList[i].src = getBse64ByImg(realImgList[i]);
    }
  }

  /**
   *获取img元素的bse64地址
   * @param {HTMLElement} imgEle img元素
   */
  function getBse64ByImg(imgEle) {
    const canvas = window.document.createElement("canvas");
    canvas.width = imgEle.width;
    canvas.height = imgEle.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(imgEle, 0, 0);
    return canvas.toDataURL();
  }

  /**
   *  处理canvas元素
   * @param {string} canvasSelector 注意：这里的canvasSelector是canvas元素父元素的选择器
   * @param {HTMLElement} target 源dom
   * @param {HTMLElement} cloneDom clone出来的dom
   */
  function handleCanvasDom(canvasSelector, target, cloneDom) {
    if (!canvasSelector) return;
    const canvasBoxList = target.querySelectorAll(canvasSelector);
    const cloneCanvasBoxList = cloneDom.querySelectorAll(canvasSelector);
    for (let i = 0, l = canvasBoxList.length; i < l; i++) {
      const currentCanvas = canvasBoxList[i].querySelector("canvas");
      const src = currentCanvas.toDataURL();

      //这里用style.width而不是width是因为canvas实际占据的宽高是style里面的属性，坐标计算才是本身的属性
      const width = Number.parseInt(currentCanvas.style.width);
      const height = Number.parseInt(currentCanvas.style.height);
      cloneCanvasBoxList[
        i
        ].innerHTML = `<img alt="" src="${src}" width="${width}" height="${height}" />`;
    }
  }

  /**
   *处理要隐藏的元素
   * @param {string} filterSelector 需要隐藏的元素的选择器
   * @param {HTMLElement} cloneDom clone出来的dom
   */
  function handleFilterDom(filterSelector, cloneDom) {
    if (!filterSelector) return;
    const filterDomList = cloneDom.querySelectorAll(filterSelector);
    [...filterDomList].forEach((item) => (item.style.display = "none"));
  }

  /**
   *
   *对节点的特殊处理
   * @param {Function} specialHandle 处理函数
   * @param {HTMLElement} cloneDom clone出来的dom
   */
  function handleCloneDom(specialHandle, cloneDom) {
    if (!specialHandle) return;
    specialHandle(cloneDom);
  }

  window.onload = function () {
    // downloadDomToImg(document.querySelector('div'), 'name')
  }
</script>
</body>
</html>
